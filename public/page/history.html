<div class="max-w-5xl mx-auto space-y-6 animate-fade-up">
  <!-- Header -->
  <div
    class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 mb-8"
  >
    <div>
      <h1
        class="text-3xl sm:text-4xl font-serif tracking-tight"
        data-i18n="history_title"
      >
        History
      </h1>
      <p
        class="text-base-content/50 mt-2 text-sm sm:text-base"
        data-i18n="history_desc"
      >
        Your recently generated QR codes (saved locally on your device)
      </p>
    </div>
    <button
      onclick="window.clearHistory()"
      class="btn btn-outline btn-error btn-sm hidden"
      id="clear-btn"
    >
      <svg
        class="w-4 h-4 mr-1"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
        />
      </svg>
      <span data-i18n="btn_clear_all">Clear All</span>
    </button>
  </div>

  <!-- Grid Container -->
  <div
    id="history-container"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"
  >
    <!-- Items will be injected here via JavaScript -->
  </div>

  <!-- Empty State -->
  <div
    id="empty-state"
    class="hidden flex-col items-center justify-center py-24 text-center bg-base-100 rounded-3xl border border-base-200 border-dashed"
  >
    <div
      class="w-20 h-20 mb-5 bg-base-200 rounded-full flex items-center justify-center text-4xl"
    >
      ðŸ“­
    </div>
    <h3 class="text-xl font-semibold mb-2" data-i18n="empty_title">
      No QR Codes Yet
    </h3>
    <p class="text-base-content/50 max-w-sm mb-6" data-i18n="empty_desc">
      You haven't generated any QR codes. Head back to the home page to create
      your first one!
    </p>
    <!-- Adjust href/hx-get according to your routing -->
    <a
      href="/"
      hx-get="/create"
      hx-target="#main-content"
      class="btn btn-primary"
    >
      <span data-i18n="btn_create_first">Create QR Code</span>
    </a>
  </div>
</div>

<script>
  (function () {
    // Icons for each QR Type
    const typeIcons = {
      url: "ðŸ”—",
      text: "ðŸ“",
      wifi: "ðŸ“¶",
      vcard: "ðŸ‘¤",
      email: "âœ‰ï¸",
      phone: "ðŸ“ž",
      sms: "ðŸ’¬",
      line: "ðŸ’š",
      facebook: "ðŸ“˜",
      promptpay: "ðŸ‡¹ðŸ‡­",
    };

    function loadHistory() {
      try {
        const historyData = localStorage.getItem("qrforge_history");
        const history = JSON.parse(historyData || "[]");

        const container = document.getElementById("history-container");
        const emptyState = document.getElementById("empty-state");
        const clearBtn = document.getElementById("clear-btn");

        if (!container || !emptyState || !clearBtn) return;

        if (history.length === 0) {
          container.innerHTML = "";
          emptyState.classList.remove("hidden");
          emptyState.classList.add("flex");
          clearBtn.classList.add("hidden");
          return;
        }

        emptyState.classList.add("hidden");
        emptyState.classList.remove("flex");
        clearBtn.classList.remove("hidden");

        // Render History Items
        container.innerHTML = history
          .map((item) => {
            const icon = typeIcons[item.type] || "ðŸ“„";
            const date = new Date(item.createdAt).toLocaleDateString(
              undefined,
              {
                year: "numeric",
                month: "short",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
              },
            );
            const thumbnailHtml = item.thumbnail
              ? `<img src="${item.thumbnail}" class="w-full h-full object-contain" alt="QR Thumbnail" />`
              : `<span class="text-2xl opacity-20 font-bold">QR</span>`;

            return `
            <div class="bg-base-100 p-4 rounded-2xl border border-base-200 shadow-sm flex items-center gap-4 transition-all hover:shadow-md hover:border-primary/30 group">
              
              <!-- Thumbnail -->
              <div class="w-16 h-16 shrink-0 bg-white border border-base-200 rounded-xl overflow-hidden flex items-center justify-center p-1 relative">
                ${thumbnailHtml}
              </div>
              
              <!-- Info -->
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-sm truncate text-base-content" title="${item.label}">
                  ${item.label || "Untitled"}
                </h4>
                <div class="text-[11px] text-base-content/50 mt-1 flex items-center gap-1.5 truncate">
                  <span class="inline-flex items-center gap-1 font-medium text-base-content/70">
                    ${icon} <span class="uppercase">${item.type}</span>
                  </span>
                  <span>â€¢</span>
                  <span class="truncate">${date}</span>
                </div>
              </div>

              <!-- Actions -->
              <div class="flex flex-col sm:flex-row gap-1 shrink-0 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                <button onclick="window.regenerateQR('${item.id}')" class="btn btn-square btn-ghost btn-sm" title="Regenerate">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                </button>
                <a href="${item.thumbnail}" download="qr-${item.type}-${Date.now()}.png" class="btn btn-square btn-ghost btn-sm" title="Download Image" onclick="window.showToast('Downloading...', 'info', 1500)">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                </a>
                <button onclick="window.deleteHistoryItem('${item.id}')" class="btn btn-square btn-ghost btn-sm text-error" title="Delete">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>

            </div>
          `;
          })
          .join("");
      } catch (e) {
        console.error("Failed to load history", e);
        window.showToast("Failed to load history", "error");
      }
    }

    // Attach functions to window object to be accessible by inline onclick handlers

    // Regenerate QR Code from history
    window.regenerateQR = function (id) {
      try {
        const history = JSON.parse(
          localStorage.getItem("qrforge_history") || "[]",
        );
        const item = history.find((h) => h.id === id);

        if (!item) {
          window.showToast("Item not found", "error");
          return;
        }

        // Navigate to home and populate form
        // Store item data temporarily
        sessionStorage.setItem("qrforge_regenerate", JSON.stringify(item));

        // Navigate to home
        window.location.href = "/";

        window.showToast("Loading QR code...", "info", 2000);
      } catch (e) {
        console.error("Failed to regenerate QR", e);
        window.showToast("Failed to regenerate QR code", "error");
      }
    };

    // Delete single history item
    window.deleteHistoryItem = function (id) {
      const confirmMsg = window.t
        ? window.t("confirm_delete")
        : "Are you sure you want to delete this QR code from history?";
      if (!confirm(confirmMsg)) return;

      try {
        let history = JSON.parse(
          localStorage.getItem("qrforge_history") || "[]",
        );
        const item = history.find((h) => h.id === id);
        history = history.filter((item) => item.id !== id);
        localStorage.setItem("qrforge_history", JSON.stringify(history));

        loadHistory();
        updateHistoryBadges();

        window.showToast(`"${item?.label || "Item"}" deleted`, "success", 2000);
      } catch (e) {
        console.error("Failed to delete item", e);
        window.showToast("Failed to delete item", "error");
      }
    };

    // Clear all history
    window.clearHistory = function () {
      const confirmMsg = window.t
        ? window.t("confirm_clear")
        : "Are you sure you want to clear ALL history? This cannot be undone.";
      if (!confirm(confirmMsg)) return;

      try {
        const count = JSON.parse(
          localStorage.getItem("qrforge_history") || "[]",
        ).length;
        localStorage.removeItem("qrforge_history");

        loadHistory();
        updateHistoryBadges();

        window.showToast(
          `${count} item${count !== 1 ? "s" : ""} cleared`,
          "success",
          2000,
        );
      } catch (e) {
        console.error("Failed to clear history", e);
        window.showToast("Failed to clear history", "error");
      }
    };

    // Update history badges in navbar
    function updateHistoryBadges() {
      try {
        const count = JSON.parse(
          localStorage.getItem("qrforge_history") || "[]",
        ).length;
        ["history-badge", "history-badge-mobile"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
            el.textContent = count > 99 ? "99+" : count;
            if (count === 0) el.classList.add("hidden");
            else el.classList.remove("hidden");
          }
        });
      } catch (e) {
        console.error("Failed to update badges", e);
      }
    }

    // Initialize immediately (useful for HTMX injections)
    loadHistory();
    updateHistoryBadges();
  })();
</script>
