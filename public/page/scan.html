<div class="w-full max-w-2xl mx-auto animate-fade-up pb-8">
  <!-- Header Section -->
  <div class="text-center mb-6 sm:mb-8 px-4">
    <div
      class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-primary/10 text-primary text-xs font-bold tracking-wider uppercase mb-4 shadow-sm border border-primary/20"
    >
      <svg
        class="w-3.5 h-3.5"
        fill="none"
        stroke="currentColor"
        stroke-width="2.5"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
        />
      </svg>
      <span data-i18n="scan_badge">AI Powered & Secure</span>
    </div>
    <h1
      class="text-3xl sm:text-4xl md:text-5xl font-bold mb-3 tracking-tight text-base-content leading-tight"
    >
      <span data-i18n="scan_title">Scan</span>
      <span
        class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary"
        >QR Code</span
      >
    </h1>
    <p
      class="text-base-content/60 text-base sm:text-lg max-w-md mx-auto leading-relaxed"
      data-i18n="scan_desc"
    >
      Point your camera at a QR code or upload an image to decode instantly.
    </p>
  </div>

  <!-- Main Card -->
  <div
    class="bg-base-100 rounded-3xl shadow-xl border border-base-200 overflow-hidden relative mx-4 sm:mx-0"
  >
    <!-- Decorative gradients -->
    <div
      class="absolute top-0 right-0 -mt-20 -mr-20 w-60 h-60 bg-primary/5 rounded-full blur-3xl pointer-events-none"
    ></div>
    <div
      class="absolute bottom-0 left-0 -mb-20 -ml-20 w-60 h-60 bg-secondary/5 rounded-full blur-3xl pointer-events-none"
    ></div>

    <div class="p-5 sm:p-8 relative z-10">
      <!-- Scanner UI (Active) -->
      <div id="scanner-container" class="space-y-6 transition-all duration-300">
        <!-- ===== Native Mode: @capacitor/barcode-scanner ===== -->
        <div id="native-scanner-ui" class="hidden">
          <div class="flex flex-col items-center justify-center py-10 sm:py-12">
            <div
              class="w-20 h-20 sm:w-24 sm:h-24 bg-gradient-to-br from-primary/20 to-primary/5 text-primary rounded-3xl flex items-center justify-center mb-6 shadow-lg shadow-primary/20"
            >
              <svg
                class="w-10 h-10 sm:w-12 sm:h-12"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                ></path>
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                ></path>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-base-content mb-2">
              Native Camera
            </h3>
            <p class="text-sm text-base-content/50 mb-6 text-center max-w-xs">
              Use your device's built-in camera with auto-focus for best results
            </p>
            <button
              id="native-scan-btn"
              class="btn btn-primary btn-lg rounded-full px-8 sm:px-10 shadow-lg shadow-primary/30 hover:shadow-primary/50 transition-all gap-2 mb-4 h-14"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                ></path>
              </svg>
              <span data-i18n="btn_start_camera">Scan with Camera</span>
            </button>
          </div>
        </div>

        <!-- ===== Web Mode: html5-qrcode fallback ===== -->
        <div id="web-scanner-ui">
          <!-- Camera Preview -->
          <div
            id="video-wrapper"
            class="relative w-full bg-base-200 rounded-2xl sm:rounded-3xl overflow-hidden shadow-inner flex flex-col items-center justify-center border-2 border-base-300 border-dashed group transition-all duration-300 hover:border-primary/40 active:border-primary/60"
            style="aspect-ratio: 4/3"
          >
            <!-- Permission Denied Message -->
            <div
              id="permission-denied"
              class="hidden absolute inset-0 z-30 bg-base-100 flex flex-col items-center justify-center p-6 text-center"
            >
              <div
                class="w-16 h-16 bg-error/10 text-error rounded-2xl flex items-center justify-center mb-4"
              >
                <svg
                  class="w-8 h-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                  />
                </svg>
              </div>
              <h4 class="font-semibold text-base-content mb-2">
                Camera Access Denied
              </h4>
              <p class="text-sm text-base-content/50 mb-4">
                Please allow camera access in your browser settings to scan QR
                codes.
              </p>
              <button
                onclick="location.reload()"
                class="btn btn-outline btn-sm"
              >
                Try Again
              </button>
            </div>

            <!-- Scanning Frame Overlay -->
            <div
              id="scanning-frame"
              class="absolute inset-0 z-20 pointer-events-none hidden"
            >
              <div class="absolute inset-0 bg-black/20"></div>
              <div
                class="absolute inset-8 sm:inset-12 border-2 border-white/30 rounded-2xl"
              >
                <!-- Corner markers -->
                <div
                  class="absolute -top-1 -left-1 w-6 h-6 border-t-4 border-l-4 border-primary rounded-tl-lg"
                ></div>
                <div
                  class="absolute -top-1 -right-1 w-6 h-6 border-t-4 border-r-4 border-primary rounded-tr-lg"
                ></div>
                <div
                  class="absolute -bottom-1 -left-1 w-6 h-6 border-b-4 border-l-4 border-primary rounded-bl-lg"
                ></div>
                <div
                  class="absolute -bottom-1 -right-1 w-6 h-6 border-b-4 border-r-4 border-primary rounded-br-lg"
                ></div>
                <!-- Scanning line animation -->
                <div
                  class="absolute top-0 left-0 right-0 h-0.5 bg-primary shadow-[0_0_10px_rgba(var(--p),0.8)] animate-[scan_2s_ease-in-out_infinite]"
                ></div>
              </div>
              <div class="absolute bottom-4 left-0 right-0 text-center">
                <span
                  class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-black/50 text-white text-xs font-medium backdrop-blur-sm"
                >
                  <span
                    class="w-2 h-2 bg-red-500 rounded-full animate-pulse"
                  ></span>
                  Scanning...
                </span>
              </div>
            </div>

            <div
              id="reader-video"
              class="w-full h-full absolute inset-0 z-10 bg-black"
              style="display: none"
            ></div>

            <!-- Placeholder State -->
            <div
              id="camera-placeholder"
              class="text-center p-6 z-0 flex flex-col items-center justify-center h-full w-full"
            >
              <div
                class="w-16 h-16 sm:w-20 sm:h-20 bg-base-100 shadow-lg text-primary rounded-2xl flex items-center justify-center mb-4 group-hover:scale-105 group-hover:shadow-xl transition-all duration-300"
              >
                <svg
                  class="w-8 h-8 sm:w-10 sm:h-10"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                  ></path>
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                  ></path>
                </svg>
              </div>
              <h3
                class="text-base sm:text-lg font-bold text-base-content mb-1"
                data-i18n="camera_access"
              >
                Camera Access
              </h3>
              <p
                class="text-xs sm:text-sm text-base-content/50 mb-5 max-w-[220px]"
                data-i18n="camera_start_help"
              >
                Click below to start scanning via your webcam.
              </p>
              <button
                id="start-camera-btn"
                class="btn btn-primary rounded-full px-6 sm:px-8 shadow-lg shadow-primary/30 hover:shadow-primary/50 transition-all h-11 sm:h-12 text-sm sm:text-base"
              >
                <svg
                  class="w-4 h-4 mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                  />
                </svg>
                <span data-i18n="btn_start_camera">Start Camera</span>
              </button>
            </div>

            <!-- Stop Button -->
            <button
              id="stop-camera-btn"
              class="btn btn-circle btn-error btn-sm absolute top-3 right-3 sm:top-4 sm:right-4 hidden z-40 shadow-lg hover:scale-110 transition-transform border-2 border-white/20"
              aria-label="Stop camera"
            >
              <svg
                class="w-4 h-4 sm:w-5 sm:h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <!-- Camera Tips -->
          <div
            class="flex items-center justify-center gap-4 mt-3 text-xs text-base-content/40"
          >
            <span class="flex items-center gap-1">
              <svg
                class="w-3.5 h-3.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"
                />
              </svg>
              Good lighting helps
            </span>
            <span class="w-1 h-1 bg-base-content/20 rounded-full"></span>
            <span class="flex items-center gap-1">
              <svg
                class="w-3.5 h-3.5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
                />
              </svg>
              Hold steady
            </span>
          </div>
        </div>

        <!-- Divider -->
        <div class="relative flex py-3 items-center">
          <div class="flex-grow border-t border-base-200"></div>
          <span
            class="flex-shrink-0 mx-4 text-base-content/30 text-xs font-bold uppercase tracking-widest bg-base-100 px-2"
            data-i18n="or_upload"
            >OR</span
          >
          <div class="flex-grow border-t border-base-200"></div>
        </div>

        <!-- File Upload Area -->
        <div class="w-full">
          <label
            for="qr-input-file"
            class="flex flex-col items-center justify-center w-full h-28 sm:h-32 border-2 border-dashed border-base-300 rounded-2xl cursor-pointer bg-base-100 hover:bg-base-200/30 hover:border-primary/50 transition-all group relative overflow-hidden"
          >
            <input
              type="file"
              id="qr-input-file"
              accept="image/*"
              class="hidden"
              aria-label="Upload QR code image"
            />
            <div
              class="flex flex-col items-center justify-center pt-5 pb-6 relative z-10 transition-transform group-hover:scale-105"
            >
              <div
                class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-base-200 flex items-center justify-center mb-3 group-hover:bg-primary/10 transition-colors"
              >
                <svg
                  class="w-5 h-5 sm:w-6 sm:h-6 text-base-content/40 group-hover:text-primary transition-colors"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
              </div>
              <p class="mb-1 text-sm text-base-content/70 text-center">
                <span class="font-semibold text-primary" data-i18n="upload_help"
                  >Click to upload</span
                >
                <span class="hidden sm:inline" data-i18n="upload_help_sub">
                  or drag and drop</span
                >
              </p>
              <p class="text-xs text-base-content/40">PNG, JPG, WEBP</p>
            </div>
            <div
              class="absolute inset-0 bg-gradient-to-r from-primary/0 via-primary/5 to-primary/0 opacity-0 group-hover:opacity-100 transition-opacity"
            ></div>
          </label>
        </div>
      </div>

      <!-- Result UI (Hidden by default) -->
      <div
        id="result-container"
        class="hidden space-y-6 animate-[fadeUp_0.4s_ease-out]"
      >
        <div class="text-center pt-2">
          <div class="relative inline-block mb-4">
            <div
              class="w-16 h-16 sm:w-20 sm:h-20 bg-success/10 text-success rounded-full flex items-center justify-center mx-auto"
            >
              <svg
                class="w-8 h-8 sm:w-10 sm:h-10"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2.5"
                  d="M5 13l4 4L19 7"
                ></path>
              </svg>
            </div>
            <div
              class="absolute inset-0 rounded-full bg-success/20 animate-ping opacity-20"
            ></div>
          </div>
          <h3
            class="text-2xl sm:text-3xl font-bold mb-2 text-base-content"
            data-i18n="scan_success"
          >
            Success!
          </h3>
          <p
            class="text-sm sm:text-base text-base-content/50"
            data-i18n="scan_success_desc"
          >
            Content successfully decoded.
          </p>
        </div>

        <!-- Result Card -->
        <div
          class="bg-base-200/50 rounded-2xl p-4 sm:p-6 border border-base-200"
        >
          <div class="flex justify-between items-center mb-3">
            <label
              class="text-xs uppercase tracking-wider text-base-content/50 font-bold"
              data-i18n="result_content"
              >Result Content</label
            >
            <span id="result-type-badge" class="badge badge-sm badge-neutral"
              >Text</span
            >
          </div>
          <div class="relative group">
            <div
              class="break-all font-mono text-sm text-base-content bg-base-100 p-4 sm:p-5 rounded-xl border border-base-200 min-h-[5rem] flex items-center shadow-sm overflow-x-auto"
              id="scanned-text"
            ></div>
            <button
              id="quick-copy-btn"
              class="absolute top-2 right-2 btn btn-ghost btn-xs btn-square opacity-0 group-hover:opacity-100 transition-opacity"
              title="Copy to clipboard"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
          <button
            id="copy-btn"
            class="btn btn-outline border-base-300 hover:bg-base-200 hover:border-base-400 text-base-content h-12 rounded-xl normal-case text-sm sm:text-base font-medium"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
              ></path>
            </svg>
            <span data-i18n="btn_copy">Copy Content</span>
          </button>

          <a
            id="open-link-btn"
            href="#"
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-primary h-12 rounded-xl normal-case text-sm sm:text-base font-medium hidden shadow-lg shadow-primary/20 hover:shadow-primary/30"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
              ></path>
            </svg>
            <span data-i18n="btn_open">Open Link</span>
          </a>

          <button
            id="share-btn"
            class="btn btn-outline border-base-300 hover:bg-base-200 h-12 rounded-xl normal-case text-sm sm:text-base font-medium hidden sm:flex items-center justify-center"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
              />
            </svg>
            Share
          </button>
        </div>

        <!-- Back Button -->
        <div class="text-center pt-2">
          <button
            id="scan-again-btn"
            class="btn btn-ghost text-base-content/50 hover:text-base-content hover:bg-base-200/50 -ml-2 group"
          >
            <svg
              class="w-4 h-4 mr-2 transform group-hover:-translate-x-1 transition-transform"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"
              ></path>
            </svg>
            <span data-i18n="btn_back_scan">Scan Another Code</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer Note -->
  <div class="px-4 sm:px-0 mt-6 sm:mt-8">
    <div
      class="flex items-center justify-center gap-2 text-xs text-base-content/30"
    >
      <svg
        class="w-3.5 h-3.5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
        />
      </svg>
      <span class="font-medium" data-i18n="scan_footer">
        Secure Client-Side Processing. No data is sent to servers.
      </span>
    </div>
  </div>
</div>

<style>
  /* Scanning animation */
  @keyframes scan {
    0%,
    100% {
      top: 0;
    }
    50% {
      top: 100%;
    }
  }

  /* Custom scrollbar for result text */
  #scanned-text::-webkit-scrollbar {
    height: 6px;
  }
  #scanned-text::-webkit-scrollbar-track {
    background: transparent;
  }
  #scanned-text::-webkit-scrollbar-thumb {
    background: oklch(var(--bc) / 0.2);
    border-radius: 3px;
  }

  /* Hide html5-qrcode UI elements */
  #reader-video__dashboard_section,
  #reader-video__dashboard_section_csr,
  #reader-video__header_message,
  #reader-video__scan_region,
  #reader-video__scan_region_image {
    display: none !important;
  }

  #reader-video video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: inherit;
  }

  /* Responsive adjustments */
  @media (orientation: landscape) and (max-height: 600px) {
    #video-wrapper {
      aspect-ratio: 16/9 !important;
      max-height: 60vh;
    }
  }

  /* Touch device optimizations */
  @media (hover: none) {
    #quick-copy-btn {
      opacity: 1 !important;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .animate-ping,
    .animate-\[scan_2s_ease-in-out_infinite\] {
      animation: none !important;
    }
  }
</style>

<script>
  (function () {
    // ============================================================
    // Detect: Capacitor native vs Web browser
    // ============================================================
    var isNative = !!(
      window.Capacitor &&
      window.Capacitor.isNativePlatform &&
      window.Capacitor.isNativePlatform()
    );

    // UI Elements
    var scannerContainer = document.getElementById("scanner-container");
    var resultContainer = document.getElementById("result-container");
    var nativeScannerUI = document.getElementById("native-scanner-ui");
    var webScannerUI = document.getElementById("web-scanner-ui");
    var nativeScanBtn = document.getElementById("native-scan-btn");
    var videoWrapper = document.getElementById("video-wrapper");
    var readerVideo = document.getElementById("reader-video");
    var cameraPlaceholder = document.getElementById("camera-placeholder");
    var scanningFrame = document.getElementById("scanning-frame");
    var permissionDenied = document.getElementById("permission-denied");
    var startBtn = document.getElementById("start-camera-btn");
    var stopBtn = document.getElementById("stop-camera-btn");
    var fileInput = document.getElementById("qr-input-file");
    var scannedTextEl = document.getElementById("scanned-text");
    var copyBtn = document.getElementById("copy-btn");
    var quickCopyBtn = document.getElementById("quick-copy-btn");
    var openLinkBtn = document.getElementById("open-link-btn");
    var shareBtn = document.getElementById("share-btn");
    var scanAgainBtn = document.getElementById("scan-again-btn");
    var resultTypeBadge = document.getElementById("result-type-badge");

    var html5QrCode = null;
    var currentResult = "";
    var isScanning = false;

    // Show correct UI based on platform
    if (isNative) {
      nativeScannerUI?.classList.remove("hidden");
      webScannerUI?.classList.add("hidden");
    } else {
      nativeScannerUI?.classList.add("hidden");
      webScannerUI?.classList.remove("hidden");
    }

    // ============================================================
    // Check Camera Support
    // ============================================================
    function checkCameraSupport() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast("Your browser doesn't support camera access", "error");
        startBtn?.classList.add("btn-disabled");
        startBtn && (startBtn.disabled = true);
        return false;
      }
      return true;
    }

    // ============================================================
    // NATIVE: @capacitor/barcode-scanner
    // ============================================================
    function getBarcodeScannerPlugin() {
      var P = window.Capacitor?.Plugins;
      return P?.CapacitorBarcodeScanner || P?.BarcodeScanner || null;
    }

    async function nativeScan() {
      try {
        var scanner = getBarcodeScannerPlugin();
        if (!scanner) {
          showToast("Scanner plugin not available", "error");
          return;
        }

        // Request permissions
        if (scanner.requestPermissions) {
          await scanner.requestPermissions();
        } else if (scanner.checkPermission) {
          await scanner.checkPermission({ force: true });
        }

        var result = await scanner.scanBarcode({});

        if (result?.ScanResult || result?.text) {
          onScanSuccess(result.ScanResult || result.text);
        }
      } catch (err) {
        var msg = err?.message || "Scan failed";
        if (!msg.includes("cancelled") && !msg.includes("dismissed")) {
          showToast(msg, "error");
        }
      }
    }

    function nativeScanFromFile(file) {
      webScanFromFile(file);
    }

    // ============================================================
    // WEB: html5-qrcode
    // ============================================================
    function loadHtml5Qrcode(callback) {
      if (typeof Html5Qrcode !== "undefined") {
        callback();
        return;
      }

      showToast("Loading scanner...", "info");

      var sources = [
        "/js/html5-qrcode.min.js",
        "https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js",
        "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js",
      ];
      var idx = 0;

      function tryNext() {
        if (idx >= sources.length) {
          showToast("Failed to load scanner library", "error");
          return;
        }
        var s = document.createElement("script");
        s.src = sources[idx];
        s.onload = function () {
          showToast("Scanner ready!", "success");
          callback();
        };
        s.onerror = function () {
          idx++;
          tryNext();
        };
        document.head.appendChild(s);
      }
      tryNext();
    }

    function initWebScanner() {
      if (!document.getElementById("reader-video")) return;
      try {
        html5QrCode = new Html5Qrcode("reader-video");
        window.qrScannerInstance = html5QrCode;
        console.log("html5-qrcode initialized");
      } catch (e) {
        console.error("Failed to init scanner:", e);
        showToast("Failed to initialize scanner", "error");
      }
    }

    async function startWebCamera() {
      if (!checkCameraSupport()) return;

      if (!html5QrCode) {
        // Try to initialize if not already done
        loadHtml5Qrcode(function () {
          initWebScanner();
          if (html5QrCode) doStartCamera();
        });
        return;
      }

      doStartCamera();
    }

    async function doStartCamera() {
      if (isScanning) return;

      try {
        // First check permission
        const permission = await navigator.permissions.query({
          name: "camera",
        });
        if (permission.state === "denied") {
          permissionDenied?.classList.remove("hidden");
          return;
        }
      } catch (e) {
        // Some browsers don't support permissions API, continue anyway
      }

      isScanning = true;
      startBtn && (startBtn.disabled = true);
      startBtn?.classList.add("loading");

      // Update UI
      cameraPlaceholder?.classList.add("hidden");
      readerVideo.style.display = "block";
      stopBtn?.classList.remove("hidden");
      scanningFrame?.classList.remove("hidden");

      videoWrapper?.classList.remove("border-dashed", "border-base-300");
      videoWrapper?.classList.add("border-transparent", "shadow-2xl");

      try {
        await html5QrCode.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: { width: 200, height: 200 },
            aspectRatio: 1.0,
            experimentalFeatures: { useBarCodeDetectorIfSupported: true },
            videoConstraints: {
              facingMode: "environment",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
          },
          onScanSuccess,
          (errorMessage) => {
            // Scan failure callback - silent for continuous scanning
            // console.log("Scan error:", errorMessage);
          },
        );

        console.log("Camera started successfully");
      } catch (err) {
        console.error("Camera start error:", err);

        // Try front camera as fallback
        try {
          await html5QrCode.start(
            { facingMode: "user" },
            {
              fps: 10,
              qrbox: { width: 200, height: 200 },
              aspectRatio: 1.0,
            },
            onScanSuccess,
            () => {},
          );
        } catch (err2) {
          console.error("Front camera also failed:", err2);

          if (
            err2.name === "NotAllowedError" ||
            err2.message?.includes("Permission")
          ) {
            permissionDenied?.classList.remove("hidden");
            showToast("Camera permission denied", "error");
          } else if (err2.name === "NotFoundError") {
            showToast("No camera found on this device", "error");
          } else {
            showToast(
              "Could not access camera: " + (err2.message || err2),
              "error",
            );
          }

          stopWebCamera();
        }
      } finally {
        startBtn && (startBtn.disabled = false);
        startBtn?.classList.remove("loading");
      }
    }

    async function stopWebCamera() {
      isScanning = false;

      if (html5QrCode?.isScanning) {
        try {
          await html5QrCode.stop();
          console.log("Camera stopped");
        } catch (e) {
          console.error("Error stopping camera:", e);
        }
      }
      resetWebUI();
    }

    function resetWebUI() {
      readerVideo.style.display = "none";
      cameraPlaceholder?.classList.remove("hidden");
      stopBtn?.classList.add("hidden");
      scanningFrame?.classList.add("hidden");
      permissionDenied?.classList.add("hidden");

      videoWrapper?.classList.add("border-dashed", "border-base-300");
      videoWrapper?.classList.remove("border-transparent", "shadow-2xl");
    }

    function webScanFromFile(file) {
      if (!html5QrCode) {
        loadHtml5Qrcode(function () {
          initWebScanner();
          setTimeout(() => doWebFileScan(file), 100);
        });
        return;
      }
      doWebFileScan(file);
    }

    async function doWebFileScan(file) {
      videoWrapper?.classList.add("opacity-50", "pointer-events-none");

      try {
        const text = await html5QrCode.scanFile(file, false);
        onScanSuccess(text);
      } catch (err) {
        try {
          const text = await scanViaCanvas(file);
          onScanSuccess(text);
        } catch (err2) {
          showToast(
            window.t?.("err_no_qr") || "No QR code found in image",
            "error",
          );
          fileInput.value = "";
        }
      } finally {
        videoWrapper?.classList.remove("opacity-50", "pointer-events-none");
      }
    }

    function scanViaCanvas(file) {
      return new Promise((resolve, reject) => {
        var r = new FileReader();
        r.onerror = reject;
        r.onload = function (ev) {
          var img = new Image();
          img.onerror = reject;
          img.onload = function () {
            try {
              var c = document.createElement("canvas");
              var mx = 1500,
                w = img.width,
                h = img.height;
              if (w > mx || h > mx) {
                var s = mx / Math.max(w, h);
                w = Math.round(w * s);
                h = Math.round(h * s);
              }
              c.width = w;
              c.height = h;
              c.getContext("2d").drawImage(img, 0, 0, w, h);
              c.toBlob(function (blob) {
                if (!blob) return reject(new Error("Canvas failed"));
                html5QrCode.scanFile(blob, false).then(resolve).catch(reject);
              }, "image/png");
            } catch (e) {
              reject(e);
            }
          };
          img.src = ev.target.result;
        };
        r.readAsDataURL(file);
      });
    }

    // ============================================================
    // SHARED: Result handling
    // ============================================================
    function onScanSuccess(decodedText) {
      if (!decodedText) return;
      currentResult = decodedText;

      if (!isNative) stopWebCamera();

      scannerContainer?.classList.add("hidden");
      resultContainer?.classList.remove("hidden");

      if (scannedTextEl) {
        scannedTextEl.textContent = decodedText;
        scannedTextEl.scrollLeft = 0;
      }

      // Detect content type
      var isUrl = false;
      var isEmail = false;
      var isPhone = false;

      try {
        const url = new URL(decodedText);
        isUrl = /^https?:$/.test(url.protocol);
      } catch (_) {
        isUrl = /^https?:\/\//.test(decodedText);
      }

      isEmail =
        /^mailto:/.test(decodedText) ||
        /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(decodedText);
      isPhone =
        /^tel:/.test(decodedText) || /^\+?[\d\s-()]{7,}$/.test(decodedText);

      if (isUrl) {
        resultTypeBadge.textContent = "URL";
        resultTypeBadge.className = "badge badge-sm badge-primary";
        openLinkBtn?.classList.remove("hidden");
        openLinkBtn.href = decodedText;
        shareBtn?.classList.remove("hidden");
      } else if (isEmail) {
        resultTypeBadge.textContent = "Email";
        resultTypeBadge.className = "badge badge-sm badge-secondary";
        openLinkBtn?.classList.remove("hidden");
        openLinkBtn.href = decodedText.startsWith("mailto:")
          ? decodedText
          : `mailto:${decodedText}`;
        shareBtn?.classList.remove("hidden");
      } else if (isPhone) {
        resultTypeBadge.textContent = "Phone";
        resultTypeBadge.className = "badge badge-sm badge-accent";
        openLinkBtn?.classList.remove("hidden");
        openLinkBtn.href = decodedText.startsWith("tel:")
          ? decodedText
          : `tel:${decodedText}`;
        shareBtn?.classList.remove("hidden");
      } else {
        resultTypeBadge.textContent = "Text";
        resultTypeBadge.className = "badge badge-sm badge-neutral";
        openLinkBtn?.classList.add("hidden");
        shareBtn?.classList.add("hidden");
      }

      saveToHistory(decodedText, isUrl);

      if (window.navigator.vibrate) {
        window.navigator.vibrate(50);
      }
    }

    function saveToHistory(text, isUrl) {
      var entry = {
        id:
          Date.now().toString(36) + Math.random().toString(36).substring(2, 7),
        type: isUrl ? "url" : "text",
        content: isUrl ? { url: text } : { text: text },
        style: {},
        label: text.substring(0, 50) + (text.length > 50 ? "..." : ""),
        starred: false,
        createdAt: new Date().toISOString(),
        source: "scanned",
        thumbnail: "",
      };

      try {
        var history = JSON.parse(
          localStorage.getItem("qrforge_history") || "[]",
        );
        if (
          history.length > 0 &&
          (history[0].content?.url === text ||
            history[0].content?.text === text)
        ) {
          return;
        }
        history.unshift(entry);
        if (history.length > 50) history = history.slice(0, 50);
        localStorage.setItem("qrforge_history", JSON.stringify(history));

        ["history-badge", "history-badge-mobile"].forEach(function (id) {
          var el = document.getElementById(id);
          if (el) {
            el.textContent = history.length > 99 ? "99+" : history.length;
            el.classList.remove("hidden");
          }
        });
      } catch (e) {
        console.error("Failed to save history", e);
      }
    }

    // ============================================================
    // Event Listeners
    // ============================================================
    nativeScanBtn?.addEventListener("click", nativeScan);
    startBtn?.addEventListener("click", startWebCamera);
    stopBtn?.addEventListener("click", stopWebCamera);

    scanAgainBtn?.addEventListener("click", function () {
      resultContainer?.classList.add("hidden");
      scannerContainer?.classList.remove("hidden");
      fileInput.value = "";
      currentResult = "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    function doCopy() {
      if (!currentResult) return;

      navigator.clipboard
        .writeText(currentResult)
        .then(function () {
          showToast(window.t?.("copied") || "Copied!", "success");

          var originalHTML = copyBtn.innerHTML;
          copyBtn.innerHTML =
            '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Copied!';
          copyBtn.classList.add("btn-success", "text-white", "border-success");

          setTimeout(function () {
            copyBtn.innerHTML = originalHTML;
            copyBtn.classList.remove(
              "btn-success",
              "text-white",
              "border-success",
            );
          }, 2000);
        })
        .catch(function () {
          showToast("Failed to copy", "error");
        });
    }

    copyBtn?.addEventListener("click", doCopy);
    quickCopyBtn?.addEventListener("click", doCopy);

    shareBtn?.addEventListener("click", async function () {
      if (!currentResult) return;

      if (navigator.share) {
        try {
          await navigator.share({
            title: "Scanned QR Code",
            text: currentResult,
          });
        } catch (err) {
          // User cancelled
        }
      } else {
        doCopy();
      }
    });

    fileInput?.addEventListener("change", function (e) {
      if (e.target.files.length === 0) return;
      var f = e.target.files[0];

      if (!f.type?.startsWith("image/")) {
        showToast("Please select an image file", "error");
        fileInput.value = "";
        return;
      }

      if (isNative) {
        nativeScanFromFile(f);
      } else {
        webScanFromFile(f);
      }
    });

    // Drag and drop
    var dropZone = fileInput?.closest("label");
    if (dropZone) {
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.add("border-primary", "bg-base-200");
        });
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.remove("border-primary", "bg-base-200");
        });
      });

      dropZone.addEventListener("drop", (e) => {
        var dt = e.dataTransfer;
        var files = dt.files;
        if (files.length > 0) {
          fileInput.files = files;
          fileInput.dispatchEvent(new Event("change"));
        }
      });
    }

    // Toast helper
    function showToast(message, type = "success") {
      if (window.showToast) {
        window.showToast(message, type);
      } else {
        console.log(`[${type}]`, message);
      }
    }

    // Initialize
    if (!isNative) {
      // Pre-load scanner library
      setTimeout(() => loadHtml5Qrcode(initWebScanner), 500);
    }
  })();

  // Cleanup
  (function () {
    function cleanup() {
      if (window.qrScannerInstance?.isScanning) {
        window.qrScannerInstance.stop().catch(() => {});
      }
    }

    document.body.addEventListener("htmx:beforeRequest", cleanup);
    window.addEventListener("beforeunload", cleanup);
  })();
</script>
